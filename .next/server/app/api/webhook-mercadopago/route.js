"use strict";(()=>{var e={};e.id=152,e.ids=[152],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},6298:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>q,patchFetch:()=>_,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>g});var a={};t.r(a),t.d(a,{POST:()=>p});var o=t(5419),s=t(9108),i=t(9678),u=t(8070),n=t(6323);async function p(e){try{let r=await e.json(),t=r.type,a=r.data?.id;if("payment"!==t||!a)return u.Z.json({received:!0});let o=await fetch(`https://api.mercadopago.com/v1/payments/${a}`,{headers:{Authorization:`Bearer ${process.env.MP_ACCESS_TOKEN}`}});if(!o.ok)return u.Z.json({error:"Error al consultar el pago en Mercado Pago"},{status:500});let s=await o.json();if("approved"!==s.status)return u.Z.json({received:!0,status:s.status});let i=s.metadata?.courseId,p=s.metadata?.userId,d=s.transaction_amount,c=s.payer?.email;if(!i||!p||!c)return u.Z.json({error:"Faltan metadatos para procesar el pago"},{status:400});let l=(0,n.eI)("https://qdinmvlhendpkjimagnq.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);await l.from("payments").insert([{user_id:p,course_id:i,mp_payment_id:a.toString(),amount:d,status:s.status}]);let{data:m}=await l.from("user_courses").select("*").eq("user_id",p).eq("course_id",i).maybeSingle();m||await l.from("user_courses").insert([{user_id:p,course_id:i}]);let{data:h}=await l.from("courses").select("title").eq("id",i).maybeSingle();return await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/enviar-factura`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userEmail:c,courseTitle:h?.title||"Curso adquirido",amount:d,paymentId:a})}),u.Z.json({received:!0,status:s.status})}catch(e){return console.error("[MP-WEBHOOK] Error:",e),u.Z.json({error:e.message},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhook-mercadopago/route",pathname:"/api/webhook-mercadopago",filename:"route",bundlePath:"app/api/webhook-mercadopago/route"},resolvedPagePath:"C:\\Users\\Carlos\\sl\xf1al\\src\\app\\api\\webhook-mercadopago\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:l,serverHooks:m,headerHooks:h,staticGenerationBailout:g}=d,q="/api/webhook-mercadopago/route";function _(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[638,206,323],()=>t(6298));module.exports=a})();